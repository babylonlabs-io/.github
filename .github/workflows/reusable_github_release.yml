name: Reusable Release Workflow

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string
      description:
        description: 'Release description'
        required: true
        type: string
      prerelease:
        description: 'Whether prerelease is enabled'
        required: true
        type: boolean
      include_changelog_section:
        description: 'Whether to include the changelog section in the release notes'
        required: true
        type: boolean
      changelog_path:
        description: 'Use to link to CHANGELOG.md'
        required: false
        type: string
      include_build_from_source_section:
        description: 'Whether to include the build from source section in the release notes'
        required: true
        type: boolean
        default: false
      build_command:
        description: 'Command to build from source'
        required: false
        type: string
      include_docker_image_section:
        description: 'Whether to include the docker image section in the release notes'
        required: true
        type: boolean
        default: false
      docker_image_name:
        description: 'Full Docker image reference'
        required: false
        type: string
        default: ''
      docker_image_table_template:
        description: 'Template for the Docker image section'
        required: false
        type: string
      include_dependencies_section:
        description: 'Whether to include the dependencies section in the release notes'
        required: true
        type: boolean
        default: false
      dependencies_template:
        description: 'List of dependencies'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate base release notes
        run: |
          tee release_notes.md <<EOF
          # ðŸš€ Overview
          
          ${{ inputs.description }}
          EOF

      - name: Append changelog section (if enabled)
        if: inputs.include_changelog_section
        run: |
          tee -a release_notes.md <<EOF

          # Changelog
          
          You can view the complete changelog [here](${{ inputs.changelog_path }})
          EOF

      - name: Append Build from Source section (if enabled)
        if: inputs.include_build_from_source_section
        run: |
          tee -a release_notes.md <<EOF

          # ðŸ—ï¸ Binaries

          If you prefer to build from source, use the following commands:

          \`\`\`sh
          git clone https://github.com/${{ github.repository }}.git
          cd $(basename ${{ github.repository }})
          git checkout ${{ inputs.tag }}
          ${{ inputs.build_command }}
          \`\`\`
          EOF

      - name: Append Docker Image section (if enabled)
        if: inputs.include_docker_image_section
        run: |
          if [[ -z "${{ inputs.docker_image_table_template }}" ]]; then
            tee -a release_notes.md <<EOF
          
          # ðŸ³ Docker Image
          
          | Image | Description |
          |---------------|----------------|
          | \`${{ inputs.docker_image_name }}\` | Official release image |
          EOF
          else
            tee -a release_notes.md <<EOF
          # ðŸ³ Docker Image
          ${{ inputs.docker_image_table_template }}
          EOF
          fi

      - name: Append Dependencies (if enabled)
        if: inputs.include_dependencies_section
        run: |
          tee -a release_notes.md <<EOF

          # ðŸ“¦ Dependencies

          ${{ inputs.dependencies_template }}
          EOF

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
